variables:
  BUILD_IMAGE: /build:

stages:
  - pre_build
  - build
  - test

create_build_image:
    stage: pre_build
    services:
     - docker:dind
    image: docker
    only:
      changes:
        - Cargo.*
        - Dockerfile.build
        - .gitlab-ci.yml
    before_script:
      - docker login -u gitlab-ci-token -p
    script:
      - docker build --pull -t  -f Dockerfile.build .
      - docker push

rust-latest:
    stage: test
    image:
    cache:
      key:
      paths:
        - target/
    before_script:
      - apt-get update && apt install kcov
    script:
      - cargo build --verbose
      - cargo test --no-run
      - kcov --exclude-pattern=/.cargo,/usr/lib target/cov target/debug/ipv8-*[^\.d]


