variables:
  BUILD_IMAGE: $CI_REGISTRY_IMAGE/build
  CARGO_HOME: $CI_PROJECT_DIR/cargo

stages:
  - pre_build
  - test

create_build_image:
    stage: pre_build
    services:
     - docker:dind
    image: docker
    only:
      changes:
        - Dockerfile.build
    before_script:
      - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    script:
      - docker build -t $BUILD_IMAGE -f Dockerfile.build .
      - docker push $BUILD_IMAGE

rust-latest:
    stage: test
    image: $BUILD_IMAGE
    only:
      changes:
        - src/**/*.rs
        - Cargo.*
        - .gitlab-ci.yml
        - tests/**/*.rs
        - examples/**/*.rs
        - benches/**/*.rs
    cache:
      key: ${CI_COMMIT_REF_SLUG}
      paths:
        - target/
        - cargo/
    script:
      - cargo build --verbose
      - cargo test --no-run
      - for file in target/debug/ipv8-*; do [ -x "${file}" ] || continue; mkdir -p "target/cov/$(basename $file)"; kcov --exclude-pattern=/.cargo,/usr/lib "target/cov/$(basename $file)" "$file"; done && bash <(curl -s https://codecov.io/bash)

